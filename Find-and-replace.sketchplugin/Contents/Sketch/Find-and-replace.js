const require$$0=require("events"),UI=require("sketch/ui"),Settings=require("sketch/settings"),Document=require("sketch/dom");function getDefaultExportFromCjs(s){return s&&s.__esModule&&Object.prototype.hasOwnProperty.call(s,"default")?s.default:s}var browserApi,hasRequiredBrowserApi;function requireBrowserApi(){if(hasRequiredBrowserApi)return browserApi;hasRequiredBrowserApi=1;function s(t){if(!t||t[0]!=="#"){if(t&&typeof t.isKindOfClass=="function"&&t.isKindOfClass(NSColor))return t;throw new Error("Incorrect color formating. It should be an hex color: #RRGGBBAA")}var i=t.substr(1);i.length===3?i+="F":i.length===6&&(i+="FF");var a;if(i.length===4)for(var g=0;g<4;g+=1)a+=i[g],a+=i[g];else if(i.length===8)a=i;else return NSColor.whiteColor();var u=parseInt(a.slice(0,2),16)/255,e=parseInt(a.slice(2,4),16)/255,n=parseInt(a.slice(4,6),16)/255,o=parseInt(a.slice(6,8),16)/255;return NSColor.colorWithSRGBRed_green_blue_alpha(u,e,n,o)}return browserApi=function(t,i,a){t._panel=i,t._webview=a,t._destroyed=!1,t.destroy=function(){return i.close()},t.close=function(){if(i.delegate().utils&&i.delegate().utils.parentWindow){var e=!0;t.emit("close",{get defaultPrevented(){return!e},preventDefault:function(){e=!1}}),e&&i.delegate().utils.parentWindow.endSheet(i);return}t.isClosable()&&i.performClose(null)};function g(e){t.isVisible()&&(e?(NSApplication.sharedApplication().activateIgnoringOtherApps(!0),i.makeKeyAndOrderFront(null)):(i.orderBack(null),NSApp.mainWindow().makeKeyAndOrderFront(null)))}t.focus=g.bind(this,!0),t.blur=g.bind(this,!1),t.isFocused=function(){return i.isKeyWindow()},t.isDestroyed=function(){return t._destroyed},t.show=function(){return NSApp.activateIgnoringOtherApps(!0),i.delegate().utils&&i.delegate().utils.parentWindow?i.delegate().utils.parentWindow.beginSheet_completionHandler(i,__mocha__.createBlock_function("v16@?0q8",function(){t.emit("closed")})):i.makeKeyAndOrderFront(null)},t.showInactive=function(){return i.orderFrontRegardless()},t.hide=function(){return i.orderOut(null)},t.isVisible=function(){return i.isVisible()},t.isModal=function(){return!1},t.maximize=function(){t.isMaximized()||i.zoom(null)},t.unmaximize=function(){t.isMaximized()&&i.zoom(null)},t.isMaximized=function(){if(i.styleMask()&NSResizableWindowMask)return i.isZoomed();var e=NSScreen.mainScreen().visibleFrame(),n=i.frame();return e.origin.x==n.origin.x&&e.origin.y==n.origin.y&&e.size.width==n.size.width&&e.size.height==n.size.height},t.minimize=function(){return i.miniaturize(null)},t.restore=function(){return i.deminiaturize(null)},t.isMinimized=function(){return i.isMiniaturized()},t.setFullScreen=function(e){e!==t.isFullscreen()&&i.toggleFullScreen(null)},t.isFullscreen=function(){return i.styleMask()&NSFullScreenWindowMask},t.setAspectRatio=function(e){e>0?i.setAspectRatio(NSMakeSize(e,1)):i.setResizeIncrements(NSMakeSize(1,1))},t.setBounds=function(e,n){if(!e||t.isFullscreen())return;const o=Object.assign(t.getBounds(),e);var c=NSMakeRect(o.x,0,o.width,o.height),r=NSScreen.screens().firstObject();c.origin.y=NSHeight(r.frame())-o.y,i.setFrame_display_animate(c,!0,n)},t.getBounds=function(){const e=i.frame();var n=NSScreen.screens().firstObject().frame();return{x:e.origin.x,y:Math.round(NSHeight(n)-e.origin.y),width:e.size.width,height:e.size.height}},t.setContentBounds=function(e,n){t.setBounds(e,n)},t.getContentBounds=function(){return t.getBounds()},t.setSize=function(e,n,o){return t.setBounds({width:e,height:n},o)},t.getSize=function(){var e=t.getBounds();return[e.width,e.height]},t.setContentSize=function(e,n,o){return t.setContentBounds({width:e,height:n},o)},t.getContentSize=function(){var e=t.getContentBounds();return[e.width,e.height]},t.setMinimumSize=function(e,n){const o=CGSizeMake(e,n);i.setContentMinSize(o)},t.getMinimumSize=function(){const e=i.contentMinSize();return[e.width,e.height]},t.setMaximumSize=function(e,n){const o=CGSizeMake(e,n);i.setContentMaxSize(o)},t.getMaximumSize=function(){const e=i.contentMaxSize();return[e.width,e.height]},t.setResizable=function(e){return t._setStyleMask(e,NSResizableWindowMask)},t.isResizable=function(){return i.styleMask()&NSResizableWindowMask},t.setMovable=function(e){return i.setMovable(e)},t.isMovable=function(){return i.isMovable()},t.setMinimizable=function(e){return t._setStyleMask(e,NSMiniaturizableWindowMask)},t.isMinimizable=function(){return i.styleMask()&NSMiniaturizableWindowMask},t.setMaximizable=function(e){i.standardWindowButton(NSWindowZoomButton)&&i.standardWindowButton(NSWindowZoomButton).setEnabled(e)},t.isMaximizable=function(){return i.standardWindowButton(NSWindowZoomButton)&&i.standardWindowButton(NSWindowZoomButton).isEnabled()},t.setFullScreenable=function(e){t._setCollectionBehavior(e,NSWindowCollectionBehaviorFullScreenPrimary),t._setCollectionBehavior(!e,NSWindowCollectionBehaviorFullScreenAuxiliary)},t.isFullScreenable=function(){var e=i.collectionBehavior();return e&NSWindowCollectionBehaviorFullScreenPrimary},t.setClosable=function(e){t._setStyleMask(e,NSClosableWindowMask)},t.isClosable=function(){return i.styleMask()&NSClosableWindowMask},t.setAlwaysOnTop=function(e,n,o){var c=NSNormalWindowLevel,r=CGWindowLevelForKey(kCGMaximumWindowLevelKey),m=CGWindowLevelForKey(kCGMinimumWindowLevelKey);e&&(n==="normal"?c=NSNormalWindowLevel:n==="torn-off-menu"?c=NSTornOffMenuWindowLevel:n==="modal-panel"?c=NSModalPanelWindowLevel:n==="main-menu"?c=NSMainMenuWindowLevel:n==="status"?c=NSStatusWindowLevel:n==="pop-up-menu"?c=NSPopUpMenuWindowLevel:n==="screen-saver"?c=NSScreenSaverWindowLevel:n==="dock"?c=NSDockWindowLevel:c=NSFloatingWindowLevel);var p=c+(o||0);if(p>=m&&p<=r)i.setLevel(p);else throw new Error("relativeLevel must be between "+m+" and "+r)},t.isAlwaysOnTop=function(){return i.level()!==NSNormalWindowLevel},t.moveTop=function(){return i.orderFrontRegardless()},t.center=function(){i.center()},t.setPosition=function(e,n,o){return t.setBounds({x:e,y:n},o)},t.getPosition=function(){var e=t.getBounds();return[e.x,e.y]},t.setTitle=function(e){i.setTitle(e)},t.getTitle=function(){return String(i.title())};var u=0;t.flashFrame=function(e){e?u=NSApp.requestUserAttention(NSInformationalRequest):(NSApp.cancelUserAttentionRequest(u),u=0)},t.getNativeWindowHandle=function(){return i},t.getNativeWebViewHandle=function(){return a},t.loadURL=function(e){if(/^(?!https?|file).*\.html?$/.test(e)&&typeof __command<"u"&&__command.pluginBundle()&&(e="file://"+__command.pluginBundle().urlForResourceNamed(e).path()),/^file:\/\/.*\.html?$/.test(e)){e=NSString.alloc().initWithString(e),e=e.stringByAddingPercentEncodingWithAllowedCharacters(NSCharacterSet.URLQueryAllowedCharacterSet()),a.loadFileURL_allowingReadAccessToURL(NSURL.URLWithString(e),NSURL.URLWithString("file:///"));return}const n=NSURL.URLWithString(e),o=NSURLRequest.requestWithURL(n);a.loadRequest(o)},t.reload=function(){a.reload()},t.setHasShadow=function(e){return i.setHasShadow(e)},t.hasShadow=function(){return i.hasShadow()},t.setOpacity=function(e){return i.setAlphaValue(e)},t.getOpacity=function(){return i.alphaValue()},t.setVisibleOnAllWorkspaces=function(e){return t._setCollectionBehavior(e,NSWindowCollectionBehaviorCanJoinAllSpaces)},t.isVisibleOnAllWorkspaces=function(){var e=i.collectionBehavior();return e&NSWindowCollectionBehaviorCanJoinAllSpaces},t.setIgnoreMouseEvents=function(e){return i.setIgnoresMouseEvents(e)},t.setContentProtection=function(e){i.setSharingType(e?NSWindowSharingNone:NSWindowSharingReadOnly)},t.setAutoHideCursor=function(e){i.setDisableAutoHideCursor(e)},t.setVibrancy=function(e){var n=t._vibrantView;if(!e){if(n==null)return;n.removeFromSuperview(),i.setVibrantView(null);return}if(n==null){var o=i.contentView();n=NSVisualEffectView.alloc().initWithFrame(o.bounds()),t._vibrantView=n,n.setAutoresizingMask(NSViewWidthSizable|NSViewHeightSizable),n.setBlendingMode(NSVisualEffectBlendingModeBehindWindow),n.setState(NSVisualEffectStateActive),n.setFrame(o.bounds()),o.addSubview_positioned_relativeTo(n,NSWindowBelow,null)}var c=NSVisualEffectMaterialLight;e==="appearance-based"?c=NSVisualEffectMaterialAppearanceBased:e==="light"?c=NSVisualEffectMaterialLight:e==="dark"?c=NSVisualEffectMaterialDark:e==="titlebar"?c=NSVisualEffectMaterialTitlebar:e==="selection"?c=NSVisualEffectMaterialSelection:e==="menu"?c=NSVisualEffectMaterialMenu:e==="popover"?c=NSVisualEffectMaterialPopover:e==="sidebar"?c=NSVisualEffectMaterialSidebar:e==="medium-light"?c=NSVisualEffectMaterialMediumLight:e==="ultra-dark"&&(c=NSVisualEffectMaterialUltraDark),n.setMaterial(c)},t._setBackgroundColor=function(e){var n=s(e);a.setValue_forKey(!1,"drawsBackground"),i.backgroundColor=n},t._invalidate=function(){i.flushWindow(),i.contentView().setNeedsDisplay(!0)},t._setStyleMask=function(e,n){var o=t.isMaximizable();e?i.setStyleMask(i.styleMask()|n):i.setStyleMask(i.styleMask()&~n),t.setMaximizable(o)},t._setCollectionBehavior=function(e,n){var o=t.isMaximizable();e?i.setCollectionBehavior(i.collectionBehavior()|n):i.setCollectionBehavior(i.collectionBehavior()&~n),t.setMaximizable(o)},t._showWindowButton=function(e){var n=i.standardWindowButton(e);n.superview().addSubview_positioned_relative(n,NSWindowAbove,null)}},browserApi}var executeJavascript={exports:{}},constants,hasRequiredConstants;function requireConstants(){return hasRequiredConstants||(hasRequiredConstants=1,constants={JS_BRIDGE:"__skpm_sketchBridge",JS_BRIDGE_RESULT_SUCCESS:"__skpm_sketchBridge_success",JS_BRIDGE_RESULT_ERROR:"__skpm_sketchBridge_error",START_MOVING_WINDOW:"__skpm_startMovingWindow",EXECUTE_JAVASCRIPT:"__skpm_executeJS",EXECUTE_JAVASCRIPT_SUCCESS:"__skpm_executeJS_success_",EXECUTE_JAVASCRIPT_ERROR:"__skpm_executeJS_error_"}),constants}var hasRequiredExecuteJavascript;function requireExecuteJavascript(){return hasRequiredExecuteJavascript||(hasRequiredExecuteJavascript=1,function(s){var t=requireConstants();s.exports=function(i,a){function g(u,e,n){typeof e=="function"&&(n=e,e=!1);var o=coscript.createFiber();return i.navigationDelegate().state&&i.navigationDelegate().state.wasReady==0?new Promise(function(c,r){a.once("ready-to-show",function(){g(u,e,n).then(c).catch(r),o.cleanup()})}):new Promise(function(c,r){var m=Math.random();a.webContents.on(t.EXECUTE_JAVASCRIPT_SUCCESS+m,function(p){try{n&&n(null,p),c(p)}catch(C){r(C)}o.cleanup()}),a.webContents.on(t.EXECUTE_JAVASCRIPT_ERROR+m,function(p){try{n?(n(p),c()):r(p)}catch(C){r(C)}o.cleanup()}),i.evaluateJavaScript_completionHandler(s.exports.wrapScript(u,m),null)})}return g},s.exports.wrapScript=function(i,a){return"window."+t.EXECUTE_JAVASCRIPT+"("+a+", "+JSON.stringify(i)+")"},s.exports.injectScript=function(i){var a="window."+t.EXECUTE_JAVASCRIPT+' = function(id, script) {  try {    var res = eval(script);    if (res && typeof res.then === "function" && typeof res.catch === "function") {      res.then(function (res2) {        window.postMessage("'+t.EXECUTE_JAVASCRIPT_SUCCESS+'" + id, res2);      })      .catch(function (err) {        window.postMessage("'+t.EXECUTE_JAVASCRIPT_ERROR+'" + id, err);      })    } else {      window.postMessage("'+t.EXECUTE_JAVASCRIPT_SUCCESS+'" + id, res);    }  } catch (err) {    window.postMessage("'+t.EXECUTE_JAVASCRIPT_ERROR+'" + id, err);  }}',g=WKUserScript.alloc().initWithSource_injectionTime_forMainFrameOnly(a,0,!0);i.configuration().userContentController().addUserScript(g)}}(executeJavascript)),executeJavascript.exports}var webviewApi,hasRequiredWebviewApi;function requireWebviewApi(){if(hasRequiredWebviewApi)return webviewApi;hasRequiredWebviewApi=1;var s=require$$0,t=requireExecuteJavascript();return webviewApi=function(a,g,u){var e=new s;e.loadURL=a.loadURL,e.loadFile=function(){console.warn("Not implemented yet, please open a PR on https://github.com/skpm/sketch-module-web-view :)")},e.downloadURL=function(){console.warn("Not implemented yet, please open a PR on https://github.com/skpm/sketch-module-web-view :)")},e.getURL=function(){return String(u.URL())},e.getTitle=function(){return String(u.title())},e.isDestroyed=function(){console.warn("Not implemented yet, please open a PR on https://github.com/skpm/sketch-module-web-view :)")},e.focus=a.focus,e.isFocused=a.isFocused,e.isLoading=function(){return!!u.loading()},e.isLoadingMainFrame=function(){return!!u.loading()},e.isWaitingForResponse=function(){return!u.loading()},e.stop=function(){u.stopLoading()},e.reload=function(){u.reload()},e.reloadIgnoringCache=function(){u.reloadFromOrigin()},e.canGoBack=function(){return!!u.canGoBack()},e.canGoForward=function(){return!!u.canGoForward()},e.canGoToOffset=function(n){return!!u.backForwardList().itemAtIndex(n)},e.clearHistory=function(){console.warn("Not implemented yet, please open a PR on https://github.com/skpm/sketch-module-web-view :)")},e.goBack=function(){u.goBack()},e.goForward=function(){u.goForward()},e.goToIndex=function(n){var o=u.backForwardList(),c=o.backList(),r=c.count();if(r>n){u.loadRequest(NSURLRequest.requestWithURL(c[n]));return}var m=o.forwardList();if(m.count()>n-r){u.loadRequest(NSURLRequest.requestWithURL(m[n-r]));return}throw new Error("Cannot go to index "+n)},e.goToOffset=function(n){if(!e.canGoToOffset(n))throw new Error("Cannot go to offset "+n);u.loadRequest(NSURLRequest.requestWithURL(u.backForwardList().itemAtIndex(n)))},e.isCrashed=function(){console.warn("Not implemented yet, please open a PR on https://github.com/skpm/sketch-module-web-view :)")},e.setUserAgent=function(){console.warn("Not implemented yet, please open a PR on https://github.com/skpm/sketch-module-web-view :)")},e.getUserAgent=function(){const n=u.customUserAgent();return n?String(n):void 0},e.insertCSS=function(n){var o="var style = document.createElement('style'); style.innerHTML = "+n.replace(/"/,'\\"')+"; document.head.appendChild(style);",c=WKUserScript.alloc().initWithSource_injectionTime_forMainFrameOnly(o,0,!0);u.configuration().userContentController().addUserScript(c)},e.insertJS=function(n){var o=WKUserScript.alloc().initWithSource_injectionTime_forMainFrameOnly(n,0,!0);u.configuration().userContentController().addUserScript(o)},e.executeJavaScript=t(u,a),e.setIgnoreMenuShortcuts=function(){console.warn("Not implemented yet, please open a PR on https://github.com/skpm/sketch-module-web-view :)")},e.setAudioMuted=function(){console.warn("Not implemented yet, please open a PR on https://github.com/skpm/sketch-module-web-view :)")},e.isAudioMuted=function(){console.warn("Not implemented yet, please open a PR on https://github.com/skpm/sketch-module-web-view :)")},e.setZoomFactor=function(n){u.setMagnification_centeredAtPoint(n,CGPointMake(0,0))},e.getZoomFactor=function(n){n(Number(u.magnification()))},e.setZoomLevel=function(n){e.setZoomFactor(Math.pow(1.2,n))},e.getZoomLevel=function(n){n(Math.log(Number(u.magnification()))/Math.log(1.2))},e.setVisualZoomLevelLimits=function(){console.warn("Not implemented yet, please open a PR on https://github.com/skpm/sketch-module-web-view :)")},e.setLayoutZoomLevelLimits=function(){console.warn("Not implemented yet, please open a PR on https://github.com/skpm/sketch-module-web-view :)")},e.send=function(){const n="window.postMessage({isSketchMessage: true,origin: '"+String(__command.identifier())+"',args: "+JSON.stringify([].slice.call(arguments))+'}, "*")';u.evaluateJavaScript_completionHandler(n,null)},e.getNativeWebview=function(){return u},a.webContents=e},webviewApi}var fitSubview,hasRequiredFitSubview;function requireFitSubview(){if(hasRequiredFitSubview)return fitSubview;hasRequiredFitSubview=1;function s(t,i,a,g){a.addConstraint(NSLayoutConstraint.constraintWithItem_attribute_relatedBy_toItem_attribute_multiplier_constant(i,t,NSLayoutRelationEqual,a,t,1,g))}return fitSubview=function(i,a,g){g=g||[],i.setTranslatesAutoresizingMaskIntoConstraints(!1),s(NSLayoutAttributeLeft,i,a,g[0]||0),s(NSLayoutAttributeTop,i,a,g[1]||0),s(NSLayoutAttributeRight,i,a,g[2]||0),s(NSLayoutAttributeBottom,i,a,g[3]||0)},fitSubview}var dispatchFirstClick,hasRequiredDispatchFirstClick;function requireDispatchFirstClick(){if(hasRequiredDispatchFirstClick)return dispatchFirstClick;hasRequiredDispatchFirstClick=1;var s='["text", "textarea", "date", "datetime-local", "email", "number", "month", "password", "search", "tel", "time", "url", "week" ]';return dispatchFirstClick=function(t,i){var a=t.convertPoint_fromView(i.locationInWindow(),null);return"var el = document.elementFromPoint("+a.x+", "+a.y+'); if (el && el.tagName === "SELECT") {  var event = document.createEvent("MouseEvents");  event.initMouseEvent("mousedown", true, true, window);  el.dispatchEvent(event);} else if (el && '+s+'.indexOf(el.type) >= 0 && el.focus) {el.focus();} else if (el) {el.dispatchEvent(new Event("click", {bubbles: true}))}'},dispatchFirstClick}var injectClientMessaging,hasRequiredInjectClientMessaging;function requireInjectClientMessaging(){if(hasRequiredInjectClientMessaging)return injectClientMessaging;hasRequiredInjectClientMessaging=1;var s=requireConstants();return injectClientMessaging=function(t){var i=`window.originalPostMessage = window.postMessage;window.postMessage = function(actionName) {  if (!actionName) {    throw new Error('missing action name')  }  var id = String(Math.random()).replace(".", "");    var args = [].slice.call(arguments);    args.unshift(id);  return new Promise(function (resolve, reject) {    window["`+s.JS_BRIDGE_RESULT_SUCCESS+'" + id] = resolve;    window["'+s.JS_BRIDGE_RESULT_ERROR+'" + id] = reject;    window.webkit.messageHandlers.'+s.JS_BRIDGE+".postMessage(JSON.stringify(args));  });}",a=WKUserScript.alloc().initWithSource_injectionTime_forMainFrameOnly(i,0,!0);t.configuration().userContentController().addUserScript(a)},injectClientMessaging}var movableArea={},hasRequiredMovableArea;function requireMovableArea(){if(hasRequiredMovableArea)return movableArea;hasRequiredMovableArea=1;var s=requireConstants();return movableArea.injectScript=function(t){var i=`(function () {document.addEventListener('mousedown', onMouseDown);function shouldDrag(target) {  if (!target || (target.dataset || {}).appRegion === "no-drag") { return false }  if ((target.dataset || {}).appRegion === "drag") { return true }  return shouldDrag(target.parentElement)};function onMouseDown(e) {  if (e.button !== 0 || !shouldDrag(e.target)) { return }  window.postMessage("`+s.START_MOVING_WINDOW+'");};})()',a=WKUserScript.alloc().initWithSource_injectionTime_forMainFrameOnly(i,0,!0);t.configuration().userContentController().addUserScript(a)},movableArea.setupHandler=function(t){var i=null,a=null,g=null;function u(){if(!a||NSEvent.pressedMouseButtons()!==1){clearInterval(g),i=null,a=null;return}var e=NSEvent.mouseLocation();t.setPosition(a.x+(e.x-i.x),a.y+(i.y-e.y),!1)}t.webContents.on(s.START_MOVING_WINDOW,function(){i=NSEvent.mouseLocation();var e=t.getPosition();a={x:e[0],y:e[1]},g=setInterval(u,1e3/60)})},movableArea}var mochaJsDelegate,hasRequiredMochaJsDelegate;function requireMochaJsDelegate(){return hasRequiredMochaJsDelegate||(hasRequiredMochaJsDelegate=1,mochaJsDelegate=function MochaDelegate(definition,superclass){var uniqueClassName="MochaJSDelegate_DynamicClass_"+NSUUID.UUID().UUIDString(),delegateClassDesc=MOClassDescription.allocateDescriptionForClassWithName_superclass_(uniqueClassName,superclass||NSObject),handlers={},ivars={};function setHandlerForSelector(selectorString,func){var handlerHasBeenSet=selectorString in handlers,selector=NSSelectorFromString(selectorString);if(handlers[selectorString]=func,!handlerHasBeenSet){for(var args=[],regex=/:/g;regex.exec(selectorString);)args.push("arg"+args.length);var dynamicFunction=eval("(function ("+args.join(", ")+") { return handlers[selectorString].apply(this, arguments); })");delegateClassDesc.addInstanceMethodWithSelector_function(selector,dynamicFunction)}}function setIvar(s,t){var i=s in handlers;if(ivars[s]=t,!i){delegateClassDesc.addInstanceVariableWithName_typeEncoding(s,"@");var a=MOPropertyDescription.new();a.name=s,a.typeEncoding="@",a.weak=!0,a.ivarName=s,delegateClassDesc.addProperty(a)}}this.getClass=function(){return NSClassFromString(uniqueClassName)},this.getClassInstance=function(s){var t=NSClassFromString(uniqueClassName).new();return Object.keys(ivars).forEach(function(i){t[i]=ivars[i]}),Object.keys(s||{}).forEach(function(i){t[i]=s[i]}),t},this.new=this.getClassInstance,typeof definition=="object"&&Object.keys(definition).forEach(function(s){typeof definition[s]=="function"?setHandlerForSelector(s,definition[s]):setIvar(s,definition[s])}),delegateClassDesc.registerClass()}),mochaJsDelegate}var parseWebArguments,hasRequiredParseWebArguments;function requireParseWebArguments(){return hasRequiredParseWebArguments||(hasRequiredParseWebArguments=1,parseWebArguments=function(s){var t=null;try{t=JSON.parse(s)}catch{}return!t||!t.constructor||t.constructor!==Array||t.length==0?null:t}),parseWebArguments}var setDelegates,hasRequiredSetDelegates;function requireSetDelegates(){if(hasRequiredSetDelegates)return setDelegates;hasRequiredSetDelegates=1;var s=requireMochaJsDelegate(),t=requireParseWebArguments(),i=requireConstants(),a,g,u,e;return setDelegates=function(n,o,c,r){e||(e=new s({utils:null,"observeValueForKeyPath:ofObject:change:context:":function(h,l,f){const d=f[NSKeyValueChangeNewKey],R=String(d.bestMatchFromAppearancesWithNames(["NSAppearanceNameAqua","NSAppearanceNameDarkAqua"]))==="NSAppearanceNameDarkAqua";this.utils.executeJavaScript("document.body.classList.remove('__skpm-"+(R?"light":"dark")+"'); document.body.classList.add('__skpm-"+(R?"dark":"light")+"')")}})),a||(a=new s({utils:null,panel:null,"windowDidResize:":function(){this.utils.emit("resize")},"windowDidMiniaturize:":function(){this.utils.emit("minimize")},"windowDidDeminiaturize:":function(){this.utils.emit("restore")},"windowDidEnterFullScreen:":function(){this.utils.emit("enter-full-screen")},"windowDidExitFullScreen:":function(){this.utils.emit("leave-full-screen")},"windowDidMove:":function(){this.utils.emit("move"),this.utils.emit("moved")},"windowShouldClose:":function(){var h=1;return this.utils.emit("close",{get defaultPrevented(){return!h},preventDefault:function(){h=0}}),h},"windowWillClose:":function(){this.utils.emit("closed")},"windowDidBecomeKey:":function(){this.utils.emit("focus",this.panel.currentEvent())},"windowDidResignKey:":function(){this.utils.emit("blur")}})),g||(g=new s({state:{wasReady:0},utils:null,"webView:didCommitNavigation:":function(h){this.utils.emit("will-navigate",{},String(String(h.URL())))},"webView:didStartProvisionalNavigation:":function(){this.utils.emit("did-start-navigation"),this.utils.emit("did-start-loading")},"webView:didReceiveServerRedirectForProvisionalNavigation:":function(){this.utils.emit("did-get-redirect-request")},"webView:didFailProvisionalNavigation:withError:":function(h,l,f){this.utils.emit("did-fail-load",f)},"webView:didFinishNavigation:":function(){this.state.wasReady==0&&(this.state.wasReady=1,this.utils.emitBrowserEvent("ready-to-show")),this.utils.emit("did-navigate"),this.utils.emit("did-frame-navigate"),this.utils.emit("did-stop-loading"),this.utils.emit("did-finish-load"),this.utils.emit("did-frame-finish-load")},"webViewWebContentProcessDidTerminate:":function(){this.utils.emit("dom-ready")}})),u||(u=new s({utils:null,"userContentController:didReceiveScriptMessage:":function(h,l){var f=this.utils.parseWebArguments(String(l.body()));f&&(!f[0]||typeof f[0]!="string"||(f[0]=String(f[0]),this.utils.emit.apply(this,f)))}}));var m=e.new({utils:{executeJavaScript(h){c.evaluateJavaScript_completionHandler(h,null)}}}),p=WKUserScript.alloc().initWithSource_injectionTime_forMainFrameOnly("document.addEventListener('DOMContentLoaded', function() { document.body.classList.add('__skpm-"+(typeof MSTheme<"u"&&MSTheme.sharedTheme().isDark()?"dark":"light")+"') }, false)",0,!0);c.configuration().userContentController().addUserScript(p),NSApplication.sharedApplication().addObserver_forKeyPath_options_context(m,"effectiveAppearance",NSKeyValueObservingOptionNew,null);var C=NSThread.mainThread().threadDictionary();C[n.id+".themeObserver"]=m;var S=g.new({utils:{setTitle:n.setTitle.bind(n),emitBrowserEvent(){try{n.emit.apply(n,arguments)}catch(h){if(typeof process<"u"&&process.listenerCount&&process.listenerCount("uncaughtException"))process.emit("uncaughtException",h,"uncaughtException");else throw console.error(h),h}},emit(){try{n.webContents.emit.apply(n.webContents,arguments)}catch(h){if(typeof process<"u"&&process.listenerCount&&process.listenerCount("uncaughtException"))process.emit("uncaughtException",h,"uncaughtException");else throw console.error(h),h}}},state:{wasReady:0}});c.setNavigationDelegate(S);var y=u.new({utils:{emit(h,l){if(!l){c.evaluateJavaScript_completionHandler(i.JS_BRIDGE_RESULT_SUCCESS+h+"()",null);return}for(var f=[],d=2;d<arguments.length;d+=1)f.push(arguments[d]);var R=n.webContents.listeners(l);Promise.all(R.map(function(v){return Promise.resolve().then(function(){return v.apply(v,f)})})).then(function(v){c.evaluateJavaScript_completionHandler(i.JS_BRIDGE_RESULT_SUCCESS+h+"("+JSON.stringify(v)+")",null)}).catch(function(v){c.evaluateJavaScript_completionHandler(i.JS_BRIDGE_RESULT_ERROR+h+"("+JSON.stringify(v)+")",null)})},parseWebArguments:t}});c.configuration().userContentController().addScriptMessageHandler_name(y,i.JS_BRIDGE);var _={emit(){try{n.emit.apply(n,arguments)}catch(h){if(typeof process<"u"&&process.listenerCount&&process.listenerCount("uncaughtException"))process.emit("uncaughtException",h,"uncaughtException");else throw console.error(h),h}}};if(r.modal){var N;r.parent.type==="Document"?N=r.parent.sketchObject:N=r.parent,N&&String(N.class())==="MSDocumentData"&&(N=N.delegate()),_.parentWindow=N.windowForSheet()}var M=a.new({utils:_,panel:o});o.setDelegate(M)},setDelegates}var lib,hasRequiredLib;function requireLib(){if(hasRequiredLib)return lib;hasRequiredLib=1;var s=require$$0,t=requireBrowserApi(),i=requireWebviewApi(),a=requireFitSubview(),g=requireDispatchFirstClick(),u=requireInjectClientMessaging(),e=requireMovableArea(),n=requireExecuteJavascript(),o=requireSetDelegates();function c(r){r=r||{};var m=r.identifier||String(NSUUID.UUID().UUIDString()),p=NSThread.mainThread().threadDictionary(),C=c.fromId(m);if(C)return C;var S=new s;if(S.id=m,r.modal&&!r.parent)throw new Error("A modal needs to have a parent.");var y=coscript.createFiber(),_=r.width||800,N=r.height||600,M=NSScreen.screens().firstObject().frame(),h=NSMakeRect(typeof r.x<"u"?r.x:Math.round((NSWidth(M)-_)/2),typeof r.y<"u"?NSHeight(M)-r.y:Math.round((NSHeight(M)-N)/2),_,N);r.titleBarStyle&&r.titleBarStyle!=="default"&&(r.frame=!1);var l=r.windowType!=="textured",f=NSTitledWindowMask;r.minimizable!==!1&&(f|=NSMiniaturizableWindowMask),r.closable!==!1&&(f|=NSClosableWindowMask),r.resizable!==!1&&(f|=NSResizableWindowMask),(!l||r.transparent||r.frame===!1)&&(f|=NSTexturedBackgroundWindowMask);var d=NSPanel.alloc().initWithContentRect_styleMask_backing_defer(h,f,NSBackingStoreBuffered,!0),R=WKWebViewConfiguration.alloc().init(),v=WKWebView.alloc().initWithFrame_configuration(CGRectMake(0,0,r.width||800,r.height||600),R);if(u(v),v.setAutoresizingMask(NSViewWidthSizable|NSViewHeightSizable),t(S,d,v),i(S,d,v),o(S,d,v,r),r.windowType==="desktop"&&(d.setLevel(kCGDesktopWindowLevel-1),d.setCollectionBehavior(NSWindowCollectionBehaviorCanJoinAllSpaces|NSWindowCollectionBehaviorStationary|NSWindowCollectionBehaviorIgnoresCycle)),(typeof r.minWidth<"u"||typeof r.minHeight<"u")&&S.setMinimumSize(r.minWidth||0,r.minHeight||0),(typeof r.maxWidth<"u"||typeof r.maxHeight<"u")&&S.setMaximumSize(r.maxWidth||1e4,r.maxHeight||1e4),r.transparent||r.frame===!1){d.titlebarAppearsTransparent=!0,d.titleVisibility=NSWindowTitleHidden,d.setOpaque(0),d.isMovableByWindowBackground=!0;var k=NSToolbar.alloc().initWithIdentifier("titlebarStylingToolbar");k.setShowsBaselineSeparator(!1),d.setToolbar(k)}if(r.titleBarStyle==="hiddenInset"){var w=NSToolbar.alloc().initWithIdentifier("titlebarStylingToolbar");w.setShowsBaselineSeparator(!1),d.setToolbar(w)}(r.frame===!1||!r.useContentSize)&&S.setSize(_,N),r.center&&S.center(),r.alwaysOnTop&&S.setAlwaysOnTop(!0),r.fullscreen&&S.setFullScreen(!0),S.setFullScreenable(!!r.fullscreenable);let E=r.title;r.frame===!1?E=void 0:typeof E>"u"&&typeof __command<"u"&&__command.pluginBundle()&&(E=__command.pluginBundle().name()),E&&S.setTitle(E);var x=r.backgroundColor;r.transparent&&(x=NSColor.clearColor()),!x&&r.frame===!1&&r.vibrancy&&(x=NSColor.clearColor()),S._setBackgroundColor(x||NSColor.windowBackgroundColor()),r.hasShadow===!1&&S.setHasShadow(!1),typeof r.opacity<"u"&&S.setOpacity(r.opacity),r.webPreferences=r.webPreferences||{},v.configuration().preferences().setValue_forKey(r.webPreferences.devTools!==!1,"developerExtrasEnabled"),v.configuration().preferences().setValue_forKey(r.webPreferences.javascript!==!1,"javaScriptEnabled"),v.configuration().preferences().setValue_forKey(!!r.webPreferences.plugins,"plugInsEnabled"),v.configuration().preferences().setValue_forKey(r.webPreferences.minimumFontSize||0,"minimumFontSize"),r.webPreferences.zoomFactor&&v.setMagnification(r.webPreferences.zoomFactor);var b=d.contentView();return r.frame!==!1?(v.setFrame(b.bounds()),b.addSubview(v)):(b.setAutoresizingMask(NSViewWidthSizable|NSViewHeightSizable),a(b,b.superview()),v.setFrame(b.bounds()),b.addSubview(v),d.standardWindowButton(NSWindowFullScreenButton)&&d.standardWindowButton(NSWindowFullScreenButton).setHidden(!0),(!r.titleBarStyle||r.titleBarStyle==="default")&&(d.standardWindowButton(NSWindowZoomButton).setHidden(!0),d.standardWindowButton(NSWindowMiniaturizeButton).setHidden(!0),d.standardWindowButton(NSWindowCloseButton).setHidden(!0),d.standardWindowButton(NSWindowZoomButton).setEnabled(!1))),r.vibrancy&&S.setVibrancy(r.vibrancy),S.setMaximizable(r.maximizable!==!1),d.setHidesOnDeactivate(r.hidesOnDeactivate!==!1),r.remembersWindowFrame&&(d.setFrameAutosaveName(m),d.setFrameUsingName_force(d.frameAutosaveName(),!1)),r.acceptsFirstMouse&&S.on("focus",function(A){A.type()===NSEventTypeLeftMouseDown&&S.webContents.executeJavaScript(g(v,A)).catch(()=>{})}),n.injectScript(v),e.injectScript(v),e.setupHandler(S),r.show!==!1&&S.show(),S.on("closed",function(){S._destroyed=!0,p.removeObjectForKey(m);var A=p[m+".themeObserver"];A&&(NSApplication.sharedApplication().removeObserver_forKeyPath(A,"effectiveAppearance"),p.removeObjectForKey(m+".themeObserver")),y.cleanup()}),p[m]=d,y.onCleanup(function(){S._destroyed||S.destroy()}),S}return c.fromId=function(r){var m=NSThread.mainThread().threadDictionary();if(m[r])return c.fromPanel(m[r],r)},c.fromPanel=function(r,m){var p=new s;if(p.id=m,!r||!r.contentView)throw new Error("needs to pass an NSPanel");for(var C=null,S=r.contentView().subviews(),y=0;y<S.length;y+=1)!C&&!S[y].isKindOfClass(WKInspectorWKWebView)&&S[y].isKindOfClass(WKWebView)&&(C=S[y]);if(!C)throw new Error("The panel needs to have a webview");return t(p,r,C),i(p,r,C),p},lib=c,lib}var libExports=requireLib();const BrowserWindow=getDefaultExportFromCjs(libExports);var remote={exports:{}};(function(s){var t=NSThread.mainThread().threadDictionary();s.exports.getWebview=function(i){return requireLib().fromId(i)},s.exports.isWebviewPresent=function(a){return!!t[a]},s.exports.sendToWebview=function(a,g){if(s.exports.isWebviewPresent(a)){for(var u=t[a],e=null,n=u.contentView().subviews(),o=0;o<n.length;o+=1)!e&&!n[o].isKindOfClass(WKInspectorWKWebView)&&n[o].isKindOfClass(WKWebView)&&(e=n[o]);if(!e||!e.evaluateJavaScript_completionHandler)throw new Error("Webview "+a+" not found");e.evaluateJavaScript_completionHandler(g,null)}}})(remote);var remoteExports=remote.exports;const version="2.12.2",pack={version},PREFUNIQUKEY="cx.icai.sketch-find-and-replace.pref",SATEUNIQUKEY="cx.icai.sketch-find-and-replace.state",defaultSettings={findString:"",replaceString:"",document:!1,regexActive:!1,caseSensitive:!1,wholeWord:!1,count:0};function escapeRegExp(s){return s.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function escapeReplaceString(s){return s}const debounce=(s,t)=>{let i;return function(){const a=()=>s.apply(this,arguments);clearTimeout(i),i=setTimeout(a,t)}};function FindAndReplace(s){let t="";UI&&UI.getTheme&&(t=UI.getTheme()),t==="dark"?defaultSettings.darkMode=!0:defaultSettings.darkMode=!1;const i=Settings.settingForKey(SATEUNIQUKEY);let a=Object.assign({},defaultSettings);if(typeof i=="string"&&i=="Loaded"){Settings.setSettingForKey(SATEUNIQUKEY,"");const l=Settings.settingForKey(PREFUNIQUKEY);typeof l=="string"&&typeof JSON.parse(l)=="object"?a=Object.assign({},defaultSettings,JSON.parse(l)):Settings.setSettingForKey(PREFUNIQUKEY,JSON.stringify({}))}Settings.setSettingForKey(SATEUNIQUKEY,"Loaded");let g=[],u=[];const e=Document.getSelectedDocument();let n=null;if(e){const l=e.selectedLayers;n=l.layers,l.length>0?(UI.message("Find and replace in the selection (v"+pack.version+")",e),a=Object.assign({},a,{findMode:1,selection:!0})):(UI.message("Find and replace in the current page (v"+pack.version+")",e),n=e.selectedPage.layers,a=Object.assign({},a,{findMode:2,selection:!1}))}const o=l=>{const f=JSON.stringify(l,null,1);Settings.setSettingForKey(PREFUNIQUKEY,f)},c={identifier:"cx.icai.sketch-find-and-replace",width:460,height:250,resizable:!1,alwaysOnTop:!0,fullscreenable:!1,title:"Find and Replace V3",acceptFirstMouse:!0,minimizable:!1,maximizable:!1};let r=new BrowserWindow(c);r.on("closed",()=>{r=null});const p=s.plugin.url().URLByAppendingPathComponent("Contents/Resources/resources/index.html");r.loadURL(p.absoluteString());let C=r.webContents;const S=l=>{a=l,UI.message(`${a.findString} replace by ${a.replaceString}`),g=[],u=[];const f=`g${a.caseSensitive==!0?"":"i"}`,d=a.wholeWord?"(?:\\^|\\b)":"",R=a.wholeWord?"(?=\\b|\\$)":"",v=a.regexActive?`${d}${a.findString}${R}`:`${d}(?:${escapeRegExp(a.findString)})${R}`,k=new RegExp(v,f),{findMode:w}=a;switch(w){case 1:e&&e.selectedLayers.length>0&&(n=e.selectedLayers.layers);break;case 3:n=e.pages;break;default:n=e.selectedPage.layers}a=Object.assign({},a,{regex:k}),M(n);const E=g.length+u.length;a=Object.assign({},a,{count:E}),N()},y=l=>{const f=l.text.replace(a.regex,a.replaceString);l.text=f,l.text!=f&&g.push(l)},_=l=>{const f=l.value.replace(a.regex,a.replaceString);l.value=f,l.value!=f&&u.push(l)},N=l=>{l&&(a=Object.assign({},a,{init:l})),remoteExports.isWebviewPresent(c.identifier)&&remoteExports.sendToWebview(c.identifier,`updateData('${JSON.stringify(a)}')`),a=Object.assign({},a,{init:!1})},M=l=>{const{findMode:f}=a;l.forEach(d=>{switch(d.type){case"Artboard":d.layers&&d.layers.length>0&&M(d.layers);break;case"Group":d.layers&&M(d.layers);break;case"Text":y(d);break;case"ShapePath":break;case"Shape":break;case"SymbolMaster":(f===1||e.selectedPage.name==="Symbols")&&M(d.layers);break;case"SymbolInstance":d.overrides&&h(d.overrides);break;case"Image":break;default:d.layers&&M(d.layers)}})},h=l=>{l.forEach(f=>{switch(f.affectedLayer.type){case"Text":f.editable&&f.property=="stringValue"&&_(f);break}})};C.once("did-finish-load",()=>{N(!0)}),C.once("close",()=>{r.close()}),C.on("message",l=>{UI.message(l)}),C.on("resetPref",()=>{Settings.setSettingForKey(SATEUNIQUKEY,""),Settings.setSettingForKey(PREFUNIQUKEY,JSON.stringify({})),UI.message("Reset Preference Settings 🖖! Done")}),C.on("setDarkMode",l=>{a=Object.assign({},a,{darkMode:l}),o(a),UI.message(`Set darkMode ${l?"on 🌙":"off 😎"}!`)}),C.on("find",debounce(l=>{Object.assign({},JSON.parse(l)).findString!=a.findString},100)),C.on("replace",debounce(l=>{const f=Object.assign({},JSON.parse(l));S(f),o(a),r.close()},100)),C.on("selection",debounce(l=>{a=Object.assign({},JSON.parse(l));const{findMode:f}=a;e&&(n=e.selectedLayers,n.length>0&&f==1?(UI.message("Find and replace in the selection"),a=Object.assign({},a,{findMode:1,selection:!0})):(UI.message("Find and replace in the current page"),n=e.selectedPage.layers,a=Object.assign({},a,{findMode:2,selection:!1}))),o(a),N(!1)},100))}globalThis['onRun'] = FindAndReplace;
